<h1 id="id_top">快速入门</h1>

* [快速试用](#id_try)
* [更多](#id_adv)
    * [脚本工具](#id_adv_tools)
    * [预备工作](#id_adv_prepare)
    * [安装第三方依赖](#id_adv_dep)
    * [hustdb 集群部署](#id_adv_hustdb_cluster)
    * [hustmq 集群部署](#id_adv_hustmq_cluster)
* [附录](#id_appendix)

<h2 id="id_try">快速试用</h2>

这一节展示了 `huststore` 在 **单机** 上的部署试用过程，不含集群的部署内容。整个过程只有 `hustdb` 一个组件会被用到，其他的模块用不上。集群的试用请参考[这里](#id_adv)。

    $ sudo yum install -y pcre-devel

    $ wget https://github.com/Qihoo360/huststore/archive/v1.7.tar.gz -O huststore-1.7.tar.gz
    $ tar -zxf huststore-1.7.tar.gz
    $ cd huststore-1.7
    $ sh prebuild.sh --prefix=/opt/huststore
    $ sh build.sh --module=hustdb
    $ sudo chown -R $USER:$USER /opt/huststore

**警告：请确保目录 `/opt/huststore` 下有足够的磁盘空间，否则请换一个路径。**

启动服务：

    $ cd /opt/huststore/hustdb
    $ sh start.sh

测试服务：

    curl -i -X GET 'localhost:8085/status.html'

返回如下信息：

    HTTP/1.1 200 OK
	Content-Length: 3
	Content-Type: text/plain

	ok

停止服务：

    $ cd /opt/huststore/hustdb
    $ sh start.sh

[回顶部](#id_top)

<h2 id="id_adv">更多</h2>

本节展示了 `huststore` **集群** 的部署细节（非单机），集群的部署方式推荐在生产环境中使用。

* Please read the following instructions **section by section**.
* **At least two machines** are required to deploy huststore, for example: `["192.168.1.101", "192.168.1.102"]`.

**Assumption**

* `user`: `jobs`
* `machines` : `["192.168.1.101", "192.168.1.102"]`
* `hustdb`: `["192.168.1.101:8085", "192.168.1.102:8085"]`
* `hustdb ha`: `["192.168.1.101:8082", "192.168.1.102:8082"]`
* `hustmq`: `["192.168.1.101:8086", "192.168.1.102:8086"]`
* `hustmq ha`: `["192.168.1.101:8080", "192.168.1.102:8080"]`

**Please replace the arguments above (`user`, `machines`) to your real values in production environment**.

<h3 id="id_adv_tools">脚本工具</h3>

**NOTE: All of the tools below are under root folder of huststore.**

#### prebuild.sh ####

`prebuild.sh` is used to prepare the build environment of huststore, usage:  

    usage:
        sh prebuild.sh [option]
        
        [option]
            --help                             show the manual
            --prefix=PATH                      set installation prefix of 3rd & huststore
                
    sample:
        sh prebuild.sh --help
        sh prebuild.sh --prefix=/opt/huststore
        sh prebuild.sh

NOTE: if `--prefix` is not set, `prebuild.sh` will use `/opt/huststore` as default installation path.

[回顶部](#id_top)

#### build.sh ####

**NOTE: `build.sh` is generated by `prebuild.sh`, so you need to run `prebuild.sh` first.**

`build.sh` is used to build and generate installation package for OPS, usage:

    usage:
        sh build.sh [option]

        [option]
            --help                             show the manual

            --module=3rd                       build and generate installation package for third-party libs.
                                               It should be installed FIRST to build other modules.

            --module=hustdb                    build and generate installation package for hustdb
            --module=hustdbha                  build and generate installation package for hustdbha
            --module=hustmq                    build and generate installation package for hustmq
            --module=hustmqha                  build and generate installation package for hustmqha
                
    sample:
        sh build.sh --help
        sh build.sh --module=hustdb
        sh build.sh --module=3rd,hustdb
        sh build.sh --module=3rd,hustdb,hustdbha
        sh build.sh --module=3rd,hustmq,hustmqha

        sh build.sh

NOTE: if `--module` is not set, `build.sh` will build **all modules of huststore**, and generate the installation packages as following:  

    elf_3rd.tar.gz
    elf_hustdb.tar.gz
    elf_hustdbha.tar.gz
    elf_hustmq.tar.gz
    elf_hustmqha.tar.gz

These installation packages are placed in the same folder as `prebuild.sh`, which could be installed by `scp` & `tar` to production environment under installation path `/opt/huststore`:

If `--module` is set as specified name, for example, `hustdb`, then only `elf_hustdb.tar.gz` will be generated.

WARNING: **you need to build & install 3rd first** before build other modules:  
    
    $ sh build.sh --module=3rd

[回顶部](#id_top)

#### remote_scp.py ####

`remote_scp.py` is a wrapper of `scp`, which supports **batch scp**.

    usage:
        python remote_scp.py [option] [user] [host_file] [remote_folder] [local_file1] [local_file2] ...
        
        [option]
            --silent                          run in silent mode

    sample:
        python remote_scp.py jobs host.txt /opt/huststore/hustdbha/conf nginx.conf hustdbtable.json
        python remote_scp.py --silent jobs host.txt /opt/huststore/hustdbha/conf nginx.conf hustdbtable.json

[回顶部](#id_top)

#### remote_ssh.py ####

`remote_ssh.py` is a wrapper of `ssh`, which supports **batch ssh**.

    usage:
        python remote_ssh.py [option] [user] [host_file] [cmds_file]
        
        [option]
            --silent                          run in silent mode
            
    sample:
        python remote_ssh.py jobs host.txt cmds.txt
        python remote_ssh.py --silent jobs host.txt cmds.txt

[回顶部](#id_top)

#### remote_prefix.py ####

`remote_prefix.py` is used to check and set the installation path of remote machines, usage:

    usage:
        python remote_prefix.py [user] [host_file] [prefix] [owner]
    sample:
        python remote_prefix.py jobs host.txt /opt/huststore jobs

Arguments:

* `user` : username for `ssh`
* `host_file` : remote host list file
* `prefix` : installation folder
* `owner` : **owner of installation folder**

For example, if you run this command:

    python remote_prefix.py admin host.txt /opt/huststore jobs

Then `remote_prefix.py` will login by user `admin` to the machines stored in `host.txt` one by one, create folder `/opt/huststore` if it is not exist, then change its owner to user `jobs`.

For convienience, you can add contents as below to the file `/etc/sudoers` of remote machines: 

    admin ALL = (ALL) ALL

    %jobs ALL=(jobs) ALL
    User_Alias USERS = %jobs
    USERS ALL= (jobs) NOPASSWD:ALL
    USERS ALL= NOPASSWD: /bin/su - jobs

#### remote_deploy.py ####

`remote_prefix.py` is used to deploy installation package to remote machines, usage:

    usage:
        python remote_deploy.py [user] [host_file] [prefix] [tar]
    sample:
        python remote_deploy.py jobs host.txt /opt/huststore elf_hustdb.tar.gz

Arguments:

* `user` : user name for `ssh` & `scp` command
* `host_file` : remote host list stored in file
* `prefix` : installation folder in **remote host**
* `tar` : **local** elf installation package

For example, if you run this command:

    python remote_deploy.py jobs host.txt /opt/huststore elf_hustdb.tar.gz

Then `remote_deploy.py` will login by user `jobs` to the machines stored in `host.txt` one by one, copy installation package `elf_hustdb.tar.gz` to remote machine, and **untar** it to the folder `/opt/huststore`.

#### remote_service.py ####

`remote_service.py` is used to control huststore services in remote machines, usage:

    usage:
        python remote_service.py [user] [host_file] [bin_folder] [action]
        
        [action]
            --start                           start remote service
            --stop                            stop remote service
            
    sample:
        python remote_service.py jobs host.txt /opt/huststore/hustdb --start
        python remote_service.py jobs host.txt /opt/huststore/hustdb --stop

Arguments:

* `user` : user name for `ssh` & `scp` command
* `host_file` : remote host list stored in file
* `bin_folder` : binary folder of service in remote host
* `action` : start or stop service

[回顶部](#id_top)

<h3 id="id_adv_prepare">预备工作</h3>

Edit file `hosts`:  

    $ vi hosts

Add contents as below and save, **please replace to your real machines**：

    192.168.1.101
    192.168.1.102

Run `prebuild.sh` to prepare the build environment.

    $ sh prebuild.sh --prefix=/opt/huststore

**WARNING: please make sure there are enough disk spaces in `/opt/huststore`, otherwise change a different location.**

Run `remote_prefix.py` to set the installation path:  

    $ python remote_prefix.py jobs hosts /opt/huststore jobs

[回顶部](#id_top)

<h3 id="id_adv_dep">安装第三方依赖</h3>

Run instructions as below:

    $ sudo yum install -y pcre-devel
    $ sh prebuild.sh --prefix=/opt/huststore
    $ sh build.sh --module=3rd
    $ python remote_deploy.py jobs hosts /opt/huststore elf_hustdb.tar.gz

[回顶部](#id_top)

<h3 id="id_adv_hustdb_cluster">hustdb 集群部署</h3>

#### hustdb ####

Build and make installation package of `hustdb`: 

    $ sh build.sh --module=hustdb

Deploy `hustdb`:

    $ python remote_deploy.py jobs hosts /opt/huststore elf_hustdb.tar.gz

Start service

    $ python remote_service.py jobs hosts /opt/huststore/hustdb --start
输入如下测试命令：

    curl -i -X GET '192.168.1.101:8085/status.html'
    curl -i -X GET '192.168.1.102:8085/status.html'

可以看到服务器返回如下内容：

    HTTP/1.1 200 OK
	Content-Length: 3
	Content-Type: text/plain

	ok

返回该结果说明服务器工作正常。

[回顶部](#id_top)

#### hustdb ha ####

Build and make installation package of `hustdb ha`: 

    $ sh build.sh --module=hustdbha

打开配置文件：  

    $ cd hustdb/ha/nginx/conf/
    $ vi nginx.json

**替换 `backends` 为真实的 `hustdb` 机器列表：**

    {
        ......
        "proxy":
        {
            ......
            "backends": 
            [
                "192.168.1.101:8085", 
                "192.168.1.102:8085"
            ],
            ......
        }
    }

运行 `genconf.py` 生成 `nginx.conf`：

    $ python genconf.py

编辑 `hosts` 文件：
    
    $ vi hosts

添加内容如下，**请替换为真实的 hustdb 节点**：

    192.168.1.101:9999
    192.168.1.102:9999

运行命令：

    $ python gen_table.py hosts hustdbtable.json

Switch to the root folder:

    $ cd ../../../../

Deploy `hustdb ha`:

    $ python remote_deploy.py jobs hosts /opt/huststore elf_hustdbha.tar.gz
    $ python remote_scp.py --silent jobs hosts /opt/huststore/hustdbha/conf \
          hustdb/ha/nginx/conf/nginx.conf \
          hustdb/ha/nginx/conf/hustdbtable.json

Start service

    $ python remote_service.py jobs hosts /opt/huststore/hustdbha/sbin --start
    $ python remote_service.py jobs hosts /opt/huststore/hustdbsync --start

输入如下测试命令：

    curl -i -X GET '192.168.1.101:8082/version'
    curl -i -X GET '192.168.1.102:8082/version'

可以看到服务器返回如下内容：

    HTTP/1.1 200 OK
    Server: nginx/1.10.0
    Date: Fri, 16 Dec 2016 10:56:55 GMT
    Content-Type: text/plain
    Content-Length: 13
    Connection: keep-alive

    hustdbha 1.7

返回该结果说明服务器工作正常。

[回顶部](#id_top)

<h3 id="id_adv_hustmq_cluster">hustmq 集群部署</h3>

#### hustmq ####

Build and make installation package of `hustmq`: 

    $ sh build.sh --module=hustmq

Open the configuration:  

    $ vi hustdb/db/server/module/hustdb.conf

Pay attention to the contents as below:

    [server]
    tcp.port                        = 8085
    ......
    [contentdb]
    # enable if count large than 0
    count                           = 0

Replace the value of `tcp.port` and `count` and save:

    [server]
    tcp.port                        = 8086
    ......
    [contentdb]
    # enable if count large than 0
    count                           = 256

Deploy `hustmq`:

    $ python remote_deploy.py jobs hosts /opt/huststore elf_hustmq.tar.gz
    $ python remote_scp.py --silent jobs hosts /opt/huststore/hustmq \
          hustdb/db/server/module/hustdb.conf

Start service

    $ python remote_service.py jobs hosts /opt/huststore/hustmq --start

输入如下测试命令：

    curl -i -X GET '192.168.1.101:8086/status.html'
    curl -i -X GET '192.168.1.102:8086/status.html'

可以看到服务器返回如下内容：

    HTTP/1.1 200 OK
	Content-Length: 3
	Content-Type: text/plain

	ok

返回该结果说明服务器工作正常。

[回顶部](#id_top)

#### hustmq ha ####

Build and make installation package of `hustmq ha`: 

    $ sh build.sh --module=hustmqha

打开配置文件：

    $ cd hustmq/ha/nginx/conf/
    $ vi nginx.json

**将 `backends` 替换为真实的 `hustmq` 机器列表，至少要有一个：**

    {
        ......
        "proxy":
        {
            ......
            "backends":
            [
                "192.168.1.101:8086",
                "192.168.1.102:8086"
            ],
            ......
        }
    }

运行 `genconf.py` 生成 `nginx.conf`：

    $ python genconf.py

Switch to the root folder:

    $ cd ../../../../

Deploy `hustmq ha`:

    $ python remote_deploy.py jobs hosts /opt/huststore elf_hustmqha.tar.gz
    $ python remote_scp.py --silent jobs hosts /opt/huststore/hustmqha/conf \
          hustmq/ha/nginx/conf/nginx.conf

Start service

    $ python remote_service.py jobs hosts /opt/huststore/hustmqha/sbin --start

输入如下测试命令：

    curl -i -X GET '192.168.1.101:8080/version'
    curl -i -X GET '192.168.1.102:8080/version'

可以看到服务器返回如下内容：

    HTTP/1.1 200 OK
    Server: nginx/1.10.0
    Date: Fri, 16 Dec 2016 10:54:47 GMT
    Content-Type: text/plain
    Content-Length: 13
    Connection: keep-alive

    hustmqha 1.7

返回该结果说明服务器工作正常。

[回顶部](#id_top)

<h2 id="id_appendix">附录</h2>

* [hustdb 配置细节](hustdb/doc/doc/zh/advanced/hustdb.md)
* [hustdb ha 部署细节](hustdb/doc/doc/zh/advanced/ha/deploy.md)
* [hustdb ha 配置细节](hustdb/doc/doc/zh/advanced/ha/nginx.md)
* [hustdb ha 负载均衡表](hustdb/doc/doc/zh/advanced/ha/table.md)
* [hustdb ha 日志配置](hustdb/doc/doc/zh/advanced/ha/zlog.md)
* [hustmq 配置细节](hustmq/doc/doc/zh/advanced/hustmq/index.md)
* [hustmq ha 配置细节](hustmq/doc/doc/zh/advanced/ha/nginx.md)
* [hustmq ha 部署细节](hustmq/doc/doc/zh/advanced/ha/deploy.md)

[回顶部](#id_top)

[回首页](README_ZH.md)