<h1 id="id_top">Quick Start</h1>

* [Quickstart & Try](#id_try)  
* [More](#id_adv)
    * [tools](#id_adv_tools)
    * [prepare](#id_adv_prepare)
    * [install third-party](#id_adv_dep)
    * [generate configuration](#id_adv_conf)
    * [deploy hustdb cluster](#id_adv_hustdb_cluster)
    * [deploy hustmq cluster](#id_adv_hustmq_cluster)

<h2 id="id_try">Quickstart & Try</h2>

This chapter shows the instructions of deployment for **single-machine**, not cluster. Only `hustdb` will be used for test, other modules of huststore are skipped. See more details on cluster deployment in [here](#id_adv).

    $ sudo yum install -y pcre-devel

    $ wget https://github.com/Qihoo360/huststore/archive/v1.7.tar.gz -O huststore-1.7.tar.gz
    $ tar -zxf huststore-1.7.tar.gz
    $ cd huststore-1.7
    $ sh prebuild.sh --prefix=/opt/huststore
    $ sh build.sh --module=hustdb
    $ sudo chown -R $USER:$USER /opt/huststore

**WARNING: please make sure there are enough disk spaces in `/opt/huststore`, otherwise change a different location.**

Start the service:

    $ cd /opt/huststore/hustdb
    $ sh start.sh

Test the service:

    curl -i -X GET 'localhost:8085/status.html'

Infomation returned:

    HTTP/1.1 200 OK
	Content-Length: 3
	Content-Type: text/plain

	ok

Stop the service:

    $ cd /opt/huststore/hustdb
    $ sh start.sh

[Back to top](#id_top)

<h2 id="id_adv">More</h2>

This chapter shows the instructions of deployment for **cluster**, not single-machine, which is prefered in production environment.  

* Please read the following instructions **section by section**.
* **At least two machines** are required to deploy huststore, for example: `["192.168.1.101", "192.168.1.102"]`.

**Assumption**

* `user`: `jobs`
* `machines` : `["192.168.1.101", "192.168.1.102"]`
* `hustdb`: `["192.168.1.101:8085", "192.168.1.102:8085"]`
* `hustdb ha`: `["192.168.1.101:8082", "192.168.1.102:8082"]`
* `hustmq`: `["192.168.1.101:8086", "192.168.1.102:8086"]`
* `hustmq ha`: `["192.168.1.101:8080", "192.168.1.102:8080"]`

**Please replace the arguments above (`user`, `machines`) to your real values in production environment**.

<h3 id="id_adv_tools">tools</h3>

#### prebuild.sh ####

`prebuild.sh` is used to prepare the build environment of huststore, usage:  

    usage:
        sh prebuild.sh [option]
        
        [option]
            --help                             show the manual
            --prefix=PATH                      set installation prefix of 3rd & huststore
                
    sample:
        sh prebuild.sh --help
        sh prebuild.sh --prefix=/opt/huststore
        sh prebuild.sh

NOTE: if `--prefix` is not set, `prebuild.sh` will use `/opt/huststore` as default installation path.

[Back to top](#id_top)

#### build.sh ####

**NOTE: `build.sh` is generated by `prebuild.sh`, so you need to run `prebuild.sh` first.**

`build.sh` is used to build and generate installation package for OPS, usage:

    usage:
        sh build.sh [option]

        [option]
            --help                             show the manual

            --module=3rd                       build and generate installation package for third-party libs.
                                               It should be installed FIRST to build other modules.

            --module=hustdb                    build and generate installation package for hustdb
            --module=hustdbha                  build and generate installation package for hustdbha
            --module=hustmq                    build and generate installation package for hustmq
            --module=hustmqha                  build and generate installation package for hustmqha
                
    sample:
        sh build.sh --help
        sh build.sh --module=hustdb
        sh build.sh

NOTE: if `--module` is not set, `build.sh` will build **all modules of huststore**, and generate the installation packages as following:  

    elf_3rd.tar.gz
    elf_hustdb.tar.gz
    elf_hustdbha.tar.gz
    elf_hustmq.tar.gz
    elf_hustmqha.tar.gz

These installation packages are placed in the same folder as `prebuild.sh`, which could be installed by `scp` & `tar` to production environment under installation path `/opt/huststore`:

If `--module` is set as specified name, for example, `hustdb`, then only `elf_hustdb.tar.gz` will be generated.

WARNING: **you need to build & install 3rd first** before build other modules:  
    
    $ sh build.sh --module=3rd

[Back to top](#id_top)

#### remote_prefix.py ####

`remote_prefix.py` is used to check and set the installation path of remote machines, usage:

    usage:
        python remote_prefix.py [user] [host_file] [prefix] [owner]
    sample:
        python remote_prefix.py jobs host.txt /opt/huststore jobs

Arguments:

* `user` : username for `ssh`
* `host_file` : remote host list file
* `prefix` : installation folder
* `owner` : **owner of installation folder**

For example, if you run this command:

    python remote_prefix.py admin host.txt /opt/huststore jobs

Then `remote_prefix.py` will login by user `admin` to the machines stored in `host.txt` one by one, create folder `/opt/huststore` if it is not exist, then change its owner to user `jobs`.

For convienience, you can add contents as below to the file `/etc/sudoers` of remote machines: 

    admin ALL = (ALL) ALL

    %jobs ALL=(jobs) ALL
    User_Alias USERS = %jobs
    USERS ALL= (jobs) NOPASSWD:ALL
    USERS ALL= NOPASSWD: /bin/su - jobs

#### remote_deploy.py ####

`remote_prefix.py` is used to deploy installation package to remote machines, usage:

    usage:
        python remote_deploy.py [user] [host_file] [prefix] [elf]
    sample:
        python remote_deploy.py jobs host.txt /opt/huststore elf_hustdb.tar.gz

Arguments:

* `user` : username for ssh
* `host_file` : remote host list file
* `prefix` : installation folder
* `elf` : elf installation package

For example, if you run this command:

    python remote_deploy.py jobs host.txt /opt/huststore elf_hustdb.tar.gz

Then `remote_deploy.py` will login by user `jobs` to the machines stored in `host.txt` one by one, copy installation package `elf_hustdb.tar.gz` to remote machine, and untar it to the folder `/opt/huststore`.

[Back to top](#id_top)

<h3 id="id_adv_prepare">prepare</h3>

Edit file `hosts`:  

    $ vi hosts

Add contents as below and save, **please replace to your real machines**：

    192.168.1.101
    192.168.1.102

Run `prebuild.sh` to prepare the build environment.

    $ sh prebuild.sh --prefix=/opt/huststore

**WARNING: please make sure there are enough disk spaces in `/opt/huststore`, otherwise change a different location.**

Run `remote_prefix.py` to set the installation path:  

    $ python remote_prefix.py jobs hosts /opt/huststore

[Back to top](#id_top)

<h3 id="id_adv_dep">install third-party</h3>


Run instructions as below:

    $ sudo yum install -y pcre-devel
    $ sh prebuild.sh --prefix=/opt/huststore
    $ sh build.sh --module=3rd
    $ python remote_deploy.py jobs hosts /opt/huststore elf_hustdb.tar.gz

[Back to top](#id_top)

<h3 id="id_adv_conf">generate configuration</h3>

#### hustdb ha ####

Open the configuration:  

    $ cd hustdb/ha/nginx/conf/
    $ vi nginx.json

**Replace `backends` to your real `hustdb` machine list:**

    {
        ......
        "proxy":
        {
            ......
            "backends": 
            [
                "192.168.1.101:8085", 
                "192.168.1.102:8085"
            ],
            ......
        }
    }

Execute `genconf.py` to generate `nginx.conf`:

    $ python genconf.py

Edit file `hosts`:  

    $ vi hosts

Add contents as below and save, **please replace to your real hustdb nodes**：

    192.168.1.101:8085
    192.168.1.102:8085

Execute command：

    python gen_table.py hosts hustdbtable.json

#### hustmq ha ####

Open the configuration:  

    $ cd ../../../../ # switch to the root dir of huststore

    $ cd hustmq/ha/nginx/conf/
    $ vi nginx.json

**Replace `backends` to your real `hustdb` machine list:**

    {
        ......
        "proxy":
        {
            ......
            "backends":
            [
                "192.168.1.101:8086",
                "192.168.1.102:8086"
            ],
            ......
        }
    }

Run `genconf.py` to generate `nginx.conf`:

    $ python genconf.py


[Back to top](#id_top)

<h3 id="id_adv_hustdb_cluster">deploy hustdb cluster</h3>

#### hustdb ####

Build and make installation package of `hustdb`: 

    $ cd ../../../../ # switch to the root dir of huststore
    $ sh build.sh --module=hustdb

Deploy `hustdb`:

    

Start service

    $ cd hustdb/db/server/make/linux/
    $ export LD_LIBRARY_PATH=/opt/huststore/3rd/lib
    $ ./hustdb

Type in the below command to test:

    curl -i -X GET 'localhost:8085/status.html'

Infomation returned:

    HTTP/1.1 200 OK
	Content-Length: 3
	Content-Type: text/plain

	ok

The result shows that the servers work as expected.

For detailed deployment and configuration, please check:

* [hustdb configuration](hustdb/doc/doc/en/advanced/hustdb.md)

[Back to top](#id_top)

#### hustdb ha ####

Install `ha` and `sync server`:  

    $ cd ..
    $ chmod a+x configure
    $ sh Config.sh
    $ make -j
    $ make install
    $ cd ../../sync
    $ make -j
    $ make install

Start `HA` and `sync server` **in order**:

    $ export LD_LIBRARY_PATH=/opt/huststore/3rd/lib
    $ /opt/huststore/hustdbha/sbin/nginx
    $ cd /opt/huststore/hustdbsync
    $ /opt/huststore/hustdbsync/hustdbsync

Type in commands:

    curl -i -X GET 'localhost:8082/version'

We should be able to see the below infomation:

    HTTP/1.1 200 OK
    Server: nginx/1.10.0
    Date: Fri, 16 Dec 2016 10:56:55 GMT
    Content-Type: text/plain
    Content-Length: 13
    Connection: keep-alive

    hustdbha 1.6

The result shows that the servers work as expected.

For detailed deployment and configuration, please check:

* [hustdb ha deployment](hustdb/doc/doc/en/advanced/ha/deploy.md)
* [hustdb ha configuration](hustdb/doc/doc/en/advanced/ha/nginx.md)
* [hustdb ha load balance table configuration](hustdb/doc/doc/en/advanced/ha/table.md)
* [hustdb ha log configuration](hustdb/doc/doc/en/advanced/ha/zlog.md)

[Back to top](#id_top)

<h3 id="id_adv_hustmq_cluster">deploy hustmq cluster</h3>

#### hustmq ####

Install `hustmq`(need sudo, used for libsnappy, libevhtp, libevent2.0): 

    $ cd hustdb/db/server/make/linux/
    $ sh build.sh

Target path

* `hustdb/db/server/make/linux/hustdb`
* `hustdb/db/server/make/linux/hustdb.conf`

Start service

    $ cd hustdb/db/server/make/linux/
    $ ./hustdb

Type in the below command to test:

    curl -i -X GET 'localhost:8085/status.html'

Infomation returned:

    HTTP/1.1 200 OK
	Content-Length: 3
	Content-Type: text/plain

	ok

The result shows that the servers work as expected.

For detailed deployment and configuration, please check:

* [hustmq configuration](hustmq/doc/doc/en/advanced/hustmq/index.md)

[Back to top](#id_top)

#### hustmq ha ####

After configuration, install `hustmq ha`:

    $ cd hustmq/ha/nginx
    $ sh Config.sh
    $ make -j
    $ make install

Start nginx:

    $ export LD_LIBRARY_PATH=/opt/huststore/3rd/lib
    $ /opt/huststore/hustmqha/sbin/nginx

Input the following test command:

    curl -i -X GET 'localhost:8080/version'

Then server will output the following information:

    HTTP/1.1 200 OK
    Server: nginx/1.10.0
    Date: Fri, 16 Dec 2016 10:54:47 GMT
    Content-Type: text/plain
    Content-Length: 13
    Connection: keep-alive

    hustmqha 1.6

Server works just fine if the above result is returned.

For detailed deployment and configuration, please check:

* [hustmq ha configuration](hustmq/doc/doc/en/advanced/ha/nginx.md)
* [hustmq ha deployment](hustmq/doc/doc/en/advanced/ha/deploy.md)

[Back to top](#id_top)

[Home](README.md)